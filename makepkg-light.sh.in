#!/bin/sh

###############################################################################
#            A script to imitate the packaging part of makepkg(8)             #
###############################################################################
# These steps are mostly copied from makepkg to make sure they are as expected to pacman.
# As much as possible has been cut out to make this script as simple as possible.

set -e

INSTALLDIR='@PACMAN_INSTALL_DIR@'
PACKAGEDEST='@PACMAN_PKG_DEST@'
INSTALLFILE='@PACMAN_INSTALL_FILE@'

SOURCE_DATE=$(date +%s)

echo 'Installing project...'
make DESTDIR="$INSTALLDIR" install

echo 'Copying .INSTALL...'
cp -f "$INSTALLFILE" "$INSTALLDIR"/.INSTALL

cd "$INSTALLDIR" || exit 1

echo 'Generating .PKGINFO...'
write_pkginfo() {
    echo 'pkgname = @PROJECT_NAME@'
    echo 'pkgbase = @PROJECT_NAME@'
    echo 'pkgver = @PROJECT_VERSION@'-0
    echo 'pkgdesc = @PROJECT_DESCRIPTION@'
    echo 'url ='
    echo "builddate = $SOURCE_DATE"
    echo 'packager = Unknown Packager'
    echo 'size = 0'
    echo 'arch = x86_64'
    echo 'license = GPL'
}
write_pkginfo > .PKGINFO

echo 'Generating .BUILDINFO...'
touch .BUILDINFO

echo 'Generating .MTREE file...'
find . -print0 \
    | LANG=C bsdtar -cnf - --format=mtree \
          --options='!all,use-set,type,uid,gid,mode,time,size,md5,sha256,link' \
          --null --files-from - --exclude .MTREE | gzip -c -f -n > .MTREE
touch -d @"$SOURCE_DATE" .MTREE

echo 'Compressing package...'
find . -mindepth 1 -printf '%P\0' | LANG=C bsdtar --no-fflags -canf '@CMAKE_BINARY_DIR@'/"$PACKAGEDEST" --null --files-from -

echo 'Done!'
